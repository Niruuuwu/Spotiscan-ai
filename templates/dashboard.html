<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotiscan – Your Listening Psychology</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg-main: #050509;
            --bg-panel: #111322;
            --accent: #1ed760;
            --accent-purple: #a259ff;
            --accent-pink: #ff4b81;
            --text-main: #ffffff;
            --text-muted: #b3b3b3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, sans-serif;
            background: radial-gradient(circle at top left, #281845, #050509 40%, #000);
            color: var(--text-main);
            padding: 20px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(20, 22, 40, 0.9);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .section-title {
            font-size: 13px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .panel ul li {
            padding: 6px 0;
            color: var(--text-muted);
            opacity: 0;
            transform: translateY(6px);
            animation: slideUp 0.5s ease forwards;
        }

        @keyframes slideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .roast-box {
            background: rgba(40, 20, 90, 0.45);
            padding: 20px;
            border-radius: 20px;
            min-height: 200px;
            margin-top: 16px;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-main);
            white-space: pre-wrap;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 0 25px rgba(130, 50, 255, 0.25);
            backdrop-filter: blur(25px);
        }

        .roast-box.typing::after {
            content: "▋";
            animation: blink 0.9s infinite;
            opacity: 0.7;
            margin-left: 5px;
        }

        @keyframes blink {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .button {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            color: #fff;
            padding: 12px 20px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-top: 12px;
            box-shadow: 0 0 15px rgba(160, 90, 255, 0.4);
            transition: 0.25s ease;
        }

        .button:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 0 25px rgba(255, 90, 160, 0.45);
        }

        .stat-row { margin-top: 20px; }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .progress-wrap {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.07);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress {
            background: linear-gradient(90deg, #9b4dff, #e056fd, #ff6f91, #1ed760);
            background-size: 300% 100%;
            animation: gradientMove 3s ease infinite;
            width: 0%;
            height: 100%;
            transition: width 1s ease;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
            100% { background-position: 0% 0%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>

<script>
    const summary = {{ summary | tojson | safe }};
</script>

<h1>Your Music Psychology</h1>
<p style="color:var(--text-muted); margin-bottom: 20px;">
    Based on your listening patterns, genres, and emotional chaos.
</p>

<div class="layout">

    <!-- LEFT PANEL -->
    <div class="panel">
        <div class="section-title">Your Top Artists</div>
        <ul id="artistList"></ul>

        <div class="section-title" style="margin-top:20px;">Top Tracks</div>
        <ul id="trackList"></ul>

        <div class="section-title" style="margin-top:20px;">Genres</div>
        <ul id="genreList"></ul>
    </div>

    <!-- MIDDLE PANEL -->
    <div class="panel">

        <h2 style="margin-top: 10px;">Generate Playlist</h2>

        <input 
            id="playlistPrompt"
            type="text"
            placeholder="Enter a vibe (e.g., heartbreak, gym, 2AM thoughts)"
            style="width: 100%; padding: 12px; border-radius: 12px; border: none; 
                   outline: none; background: rgba(255,255,255,0.08); 
                   color: white; margin-top: 10px;">
        >

        <button class="button" id="playlistBtn">Create Playlist</button>

        <!-- CLEAN PLAYLIST WRAPPER -->
        <div id="playlistWrapper" style="margin-top: 20px; min-height: 0;">
            <div id="playlistOutput"
                 style="font-size: 14px; color: var(--text-muted); white-space: pre-wrap;">
            </div>
        </div>

        <h2 style="margin-top: 30px;">Personality</h2>

        <button class="button" id="roastBtn">Analyze My Music</button>

        <div class="roast-box" id="roastOutput">
            Click the button to generate your roast & personality breakdown.
        </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel">
        <h2 class="section-title">Stats Breakdown</h2>

        <div class="stat-row">
            <div class="stat-label">
                <span>Artist Loyalty</span>
                <span id="loyaltyLabel">0%</span>
            </div>
            <div class="progress-wrap"><div class="progress" id="loyaltyBar"></div></div>
        </div>

        <div class="stat-row">
            <div class="stat-label">
                <span>Genre Diversity</span>
                <span id="diversityLabel">0%</span>
            </div>
            <div class="progress-wrap"><div class="progress" id="diversityBar"></div></div>
        </div>

        <p style="margin-top:16px;">Dominant Genre: <b id="dominantGenre"></b></p>
    </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {

    // ELEMENTS
    const artistList = document.getElementById("artistList");
    const trackList = document.getElementById("trackList");
    const genreList = document.getElementById("genreList");
    const loyaltyBar = document.getElementById("loyaltyBar");
    const diversityBar = document.getElementById("diversityBar");
    const loyaltyLabel = document.getElementById("loyaltyLabel");
    const diversityLabel = document.getElementById("diversityLabel");
    const dominantGenre = document.getElementById("dominantGenre");

    const roastBtn = document.getElementById("roastBtn");
    const roastOutput = document.getElementById("roastOutput");

    const playlistBtn = document.getElementById("playlistBtn");
    const playlistPrompt = document.getElementById("playlistPrompt");
    const playlistOutput = document.getElementById("playlistOutput");
    const playlistWrapper = document.getElementById("playlistWrapper");

    // POPULATE LISTS
    summary.artists.slice(0, 10).forEach(a => {
        let li = document.createElement("li");
        li.textContent = a;
        artistList.appendChild(li);
    });

    summary.tracks.slice(0, 10).forEach(t => {
        let li = document.createElement("li");
        li.textContent = t;
        trackList.appendChild(li);
    });

    summary.genres.slice(0, 10).forEach(g => {
        let li = document.createElement("li");
        li.textContent = g;
        genreList.appendChild(li);
    });

    // STATISTICS
    const loyalty = Math.min(summary.repeat_rate * 40, 100);
    const diversity = Math.min(summary.genre_diversity * 100, 100);

    loyaltyLabel.textContent = Math.round(loyalty) + "%";
    diversityLabel.textContent = Math.round(diversity) + "%";
    dominantGenre.textContent = summary.dominant_genre;

    setTimeout(() => {
        loyaltyBar.style.width = loyalty + "%";
        diversityBar.style.width = diversity + "%";
    }, 300);

    // ROAST BUTTON
    roastBtn.onclick = async () => {
        roastOutput.textContent = "Analyzing your emotional damage…";
        roastOutput.classList.add("typing");

        try {
            const res = await fetch("/roast", { method: "POST" });
            const data = await res.json();

            if (data.roast) typeRoast(data.roast);
            else roastOutput.textContent = data.error || "Error.";
        } catch {
            roastOutput.textContent = "Server error.";
        }
    };

    // PLAYLIST GENERATION BUTTON
    playlistBtn.onclick = async () => {
        const vibe = playlistPrompt.value.trim();
        if (!vibe) {
            playlistOutput.textContent = "Enter a vibe first!";
            return;
        }

        playlistOutput.textContent = "Creating your playlist…";

        try {
            const res = await fetch("/generate_playlist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: vibe })
            });

            const data = await res.json();

            if (data.playlist_url) {
                playlistWrapper.innerHTML = `
                    <div style="
                        padding: 16px; 
                        background: rgba(255,255,255,0.05); 
                        border-radius: 14px; 
                        text-align: center;
                        width: 100%;
                        animation: fadeIn 0.3s ease;">
                        
                        <p style="color: var(--text-main); margin-bottom: 12px;">
                            Your playlist is ready!
                        </p>

                        <a href="${data.playlist_url}" 
                           target="_blank"
                           style="
                                display: inline-block;
                                padding: 14px 28px;
                                border-radius: 999px;
                                background: var(--accent);
                                color: #000;
                                font-weight: 600;
                                font-size: 15px;
                                text-decoration: none;
                                box-shadow: 0 0 22px rgba(30,215,96,0.6);
                                transition: 0.2s;">
                            Open on Spotify →
                        </a>
                    </div>
                `;
            } else {
                playlistOutput.textContent = data.error || "Something failed.";
            }
        } catch (err) {
            playlistOutput.textContent = "Could not reach server.";
        }
    };
});

// TYPEWRITER EFFECT
function typeRoast(text) {
    const box = document.getElementById("roastOutput");
    box.textContent = "";
    box.classList.add("typing");

    let i = 0;
    (function type() {
        if (i < text.length) {
            box.textContent = text.slice(0, i + 1);
            i++;
            setTimeout(type, 15);
        } else {
            box.classList.remove("typing");
        }
    })();
}
</script>

</body>
</html>
